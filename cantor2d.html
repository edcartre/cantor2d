<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
  <title>D3::Cantor 2D</title>
  <link href="estilo.css" media="all" rel="stylesheet" type="text/css" />
  </head>

  <body>

<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>

<div class="header">
<h1>D3::Cantor 2D</h1>
</div>

<div class="content">

<div id='c2d' class="vis"></div>


<script>

var WIDTH = 600;
    //HEIGHT = WIDTH/2
    ORDEN = 3;
    MAXLEVEL = 3;


function randomInt(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

function gen_frac(orden, semilla, nivelmax) {
    var cuadros = [];
    nivel = 0
    function gencuadros(nivel, ind, x0, y0, tam, st) {
        //console.log(ind)
        if (nivel > nivelmax) {
            cuadros.push({"nivel":nivel, "ind":ind, "x0":x0, "y0":y0, "tam":tam, "st":st});
            return;
        }

        var nnivel = nivel + 1;
        var ntam = tam / ORDEN;

        for (var i=0; i < ORDEN; i++) {
            for (var j=0; j < ORDEN; j++) {
                var nind = ORDEN*i + j;
                gencuadros(nnivel, nind, x0 + i*ntam, y0 + j*ntam, ntam, st? semilla[nind]:0);
            }
        }

    }
    gencuadros(0, 0, 0, 0, 1, 1);
    return cuadros;
}

var esc = d3.scale.linear()
    .range([0, WIDTH]);

// Fractal
var svgfrac = d3.select('#c2d').append('svg')
    .attr({
      'width': WIDTH,
      'height': WIDTH,
      'class': "frac"
    });


var svgctrl = d3.select('#c2d').append('svg')
    .attr({
      'width': WIDTH/2,
      'height': WIDTH/2,
      'class': "ctrl"
    });

var texto = d3.select('#c2d').append( "text")
    .attr({
        'text-anchor'   : 'middle',
        y               : 10
    })

;

function update(semilla) {
    svgfrac.selectAll('rect.sem')
        .remove();

    var ctrl = svgctrl.selectAll('rect')
      .data(gen_frac(ORDEN, semilla, 0));

    ctrl.enter()
      .append('rect')
      .attr('class', function (d, i){return d.st? "on":"off"});

    ctrl.attr("height", function(d,i) { return esc(d.tam/2);})
        .attr("width", function(d,i) { return esc(d.tam/2);})
        //.style("fill", function(d,i) { return "hsl(" + esccol(i) + ",70%,50%)"; })
        .attr("x", function(d,i) { return esc(d.x0/2);})
        .attr("y", function(d,i) { return esc(d.y0/2);})
        ;
    ctrl.exit().remove()

    data = gen_frac(ORDEN, semilla, MAXLEVEL);
    //TODO: Sacar a closure
    var esccol = d3.scale.linear()
    .domain([0, data.length])
    .range([0, 360]);

    var nummax = Math.pow(ORDEN*ORDEN, MAXLEVEL+1);
    texto.text("Orden: " + ORDEN + " | Nivel: " + MAXLEVEL + " | Semilla: " + semilla  + "  | Objetos: " + data.length + " de " + nummax + " | Densidad: " + data.length/nummax);
    // Data join
    var frac = svgfrac.selectAll('rect')
        .data(data);
    // ENTER
    frac.enter()
      .append('rect')
      .filter(function(d) { return d.st  })
        .attr("width", 0)
        .attr("height", 0)
        .transition()
        .attr("height", function(d,i) { return esc(d.tam);})
        .attr("width", function(d,i) { return esc(d.tam);})
        .ease("elastic")
        .duration(2000)
        .delay(function(d, i) { return i / data.length * 2000; });
        //.delay(function(d, i) { return d.ind / semilla.length * 2000; });

    frac
        .style("fill", function(d,i) { return "hsl(" + esccol(i) + ",70%,50%)"; })
        .attr("x", function(d,i) { return esc(d.x0);})
        .attr("y", function(d,i) { return esc(d.y0);})

    ;

    frac.exit().remove();


};

update(sem_aleat());

function sem_aleat() {
    var sem = d3.range(ORDEN*ORDEN).map(function() {return Math.round(Math.random());})
    console.log(sem);
    return sem;

}


setInterval(function() {
  update(sem_aleat());
}, 5000);

</script>

</content>
</body>
</html>
